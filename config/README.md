# Config Directory

Management of configuration files for the local-network Docker Compose stack.

## Structure

```
config/
├── shared/              # Shared utilities (committed to git)
│   └── lib.sh           # Shell functions (require_jq, etc.)
├── local/              # Working copies (gitignored, auto-generated)
│   ├── horizon.json
│   ├── subgraph-service.json
│   ├── tap-contracts.json
│   └── block-oracle.json
└── README.md
```

## How It Works

### Mount Layout

Services receive two directory mounts plus a direct `.env` mount:

| Host path        | Container path     | Mode                                | Contents                                           |
| ---------------- | ------------------ | ----------------------------------- | -------------------------------------------------- |
| `config/shared/` | `/opt/shared/`     | `:ro`                               | Git-tracked utilities (`lib.sh`)                   |
| `.env`           | `/opt/config/.env` | `:ro`                               | Environment variables (ports, mnemonics, versions) |
| `config/local/`  | `/opt/config/`     | `:ro` (`:rw` for `graph-contracts`) | Generated contract address files                   |

Scripts source the env file and shared library:

```sh
. /opt/config/.env
. /opt/shared/lib.sh
token=$(require_jq '."1337".L2GraphToken.address' /opt/config/horizon.json)
```

Note: `env_file` cannot be used because several binaries (graph-node, indexer-service-rs)
interpret environment variables as configuration flags, causing collisions with `.env` entries.

### Contract Deployment (`graph-contracts` service)

- Creates empty config files on first run (if they don't exist)
- Deploys Graph protocol smart contracts (Horizon) using Hardhat Ignition
- Deploys TAP contracts (Escrow, TAPVerifier, AllocationIDTracker) using Forge
- Deploys DataEdge contract
- Writes contract addresses to `local/horizon.json`, `local/subgraph-service.json`, `local/tap-contracts.json`, and `local/block-oracle.json`

## Files

### `shared/lib.sh`

- **Committed to git**
- **Contains:** Shared shell functions (`require_jq`)
- **Mounted in:** Services as `/opt/shared/lib.sh:ro`

### `local/horizon.json`

- **Generated by:** `graph-contracts`
- **Contains:** Horizon protocol contract addresses
- **Mounted in:** Services as `/opt/config/horizon.json:ro`

### `local/subgraph-service.json`

- **Generated by:** `graph-contracts`
- **Contains:** Subgraph service contract addresses
- **Mounted in:** Services as `/opt/config/subgraph-service.json:ro`

### `local/tap-contracts.json`

- **Generated by:** `graph-contracts`
- **Contains:** TAP contract addresses (Escrow, TAPVerifier, AllocationIDTracker)
- **Mounted in:** Services as `/opt/config/tap-contracts.json:ro`

### `local/block-oracle.json`

- **Generated by:** `graph-contracts`
- **Contains:** DataEdge contract address
- **Mounted in:** Services as `/opt/config/block-oracle.json:ro`

## Cleaning

To remove generated config files and reset the environment:

```bash
./scripts/clean.sh
```

This will:

1. Stop and remove all containers
2. Optionally remove Docker volumes (postgres data, etc.)
3. **Remove all files in `config/local/`**
4. Optionally remove Docker images
