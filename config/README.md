# Config Directory

Management of configuration files for the local-network Docker Compose stack.

## Structure

```
config/
├── templates/           # Template files (committed to git)
│   ├── horizon.json
│   ├── subgraph-service.json
│   └── tap-contracts.json
├── local/              # Working copies (gitignored, auto-generated)
│   ├── horizon.json
│   ├── subgraph-service.json
│   └── tap-contracts.json
├── create-local-config-files.sh
└── README.md
```

## How It Works

### 1. Initialization (`init-config` service)
- Runs **first** before all other services
- Executes `create-local-config-files.sh`
- Copies `templates/*.json` → `local/*.json` (only when target files do not exist)
- Ensures config files are ready before other containers start

### 2. File Generation (`graph-contracts` service)
- Deploys smart contracts using Hardhat
- Writes contract addresses to mounted `local/horizon.json` and `local/subgraph-service.json`
- Adds legacy contract entries (`LegacyDisputeManager`, `LegacyServiceRegistry`) to `local/subgraph-service.json`

### 3. TAP Contracts (`tap-contracts` service)
- Deploys TAP (Timeline Aggregation Protocol) contracts
- Writes addresses to mounted `local/tap-contracts.json`

## Files

### `horizon.json`
- **Generated by:** `graph-contracts` (Hardhat deployment)
- **Contains:** Horizon protocol contract addresses
- **Mounted in:** Multiple services as `/opt/horizon.json:ro` (read-only)

### `subgraph-service.json`
- **Generated by:** `graph-contracts` (Hardhat deployment + jq patch for legacy contracts)
- **Contains:** Subgraph service contract addresses
- **Mounted in:** Multiple services as `/opt/subgraph-service.json:ro` (read-only)

### `tap-contracts.json`
- **Generated by:** `tap-contracts` (TAP deployment)
- **Contains:** TAP v1 contract addresses (legacy payment system)
- **Mounted in:** Multiple services as `/opt/tap-contracts.json:ro` (read-only)

## Cleaning

To remove generated config files and reset the environment:

```bash
./scripts/clean.sh
```

This will:
1. Stop and remove all containers
2. Optionally remove Docker volumes (postgres data, etc.)
3. **Remove all files in `config/local/`**
4. Optionally remove Docker images
