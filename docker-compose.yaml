services:
  chain:
    container_name: chain
    image: ghcr.io/foundry-rs/foundry:latest
    ports: ["${CHAIN_RPC}:8545"]
    command: ["anvil --host=0.0.0.0 --chain-id=1337 --base-fee=0"]
    healthcheck: { interval: 1s, retries: 10, test: cast block }

  ipfs:
    container_name: ipfs
    image: ipfs/kubo:v0.27.0
    ports: ["${IPFS_RPC}:5001"]
    healthcheck: { interval: 1s, retries: 10, test: ipfs id }

  postgres:
    container_name: postgres
    image: postgres:14.5-alpine
    ports: ["${POSTGRES}:5432"]
    command: ["postgres", "-cshared_preload_libraries=pg_stat_statements"]
    volumes:
      - ./postgres/setup.sql:/docker-entrypoint-initdb.d/setup.sql:ro
    environment:
      POSTGRES_INITDB_ARGS: "--encoding UTF8 --locale=C"
      POSTGRES_HOST_AUTH_METHOD: trust
      POSTGRES_USER: postgres
    healthcheck: { interval: 1s, retries: 10, test: pg_isready -U postgres }

  graph-node:
    container_name: graph-node
    build: { context: "graph-node" }
    depends_on:
      chain: { condition: service_healthy }
      ipfs: { condition: service_healthy }
      postgres: { condition: service_healthy }
    stop_signal: SIGKILL
    ports:
      - ${GRAPH_NODE_GRAPHQL}:8000
      - ${GRAPH_NODE_ADMIN}:8020
      - ${GRAPH_NODE_STATUS}:8030
      - ${GRAPH_NODE_METRICS}:8040
    volumes:
      - ./.env:/opt/.env:ro
    healthcheck:
      { interval: 1s, retries: 10, test: curl -f http://127.0.0.1:8030 }
