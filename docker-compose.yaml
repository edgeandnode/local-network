version: "3"
services:
  controller:
    container_name: controller
    build: { dockerfile: controller/Dockerfile }
    ports:
      - ${CONTROLLER}:6001

  chain:
    container_name: chain
    # image: ghcr.io/foundry-rs/foundry:latest
    build: { dockerfile: chain/Dockerfile }
    ports:
      - ${CHAIN_RPC}:8545
    command: ['anvil --host=0.0.0.0 --chain-id=1337 --mnemonic="${MNEMONIC}"']
    healthcheck:
      test: curl http://127.0.0.1:8545

  ipfs:
    container_name: ipfs
    image: ipfs/kubo:latest
    ports:
      - ${IPFS_RPC}:5001
    # healthcheck:
    #   test: wget http://0.0.0.0:5001/webui

  redpanda:
    container_name: redpanda
    image: docker.redpanda.com/redpandadata/redpanda:v23.3.5
    ports:
      - ${REDPANDA_KAFKA}:9092
      - ${REDPANDA_ADMIN}:9644
      - ${REDPANDA_PANDAPROXY}:8082
      - ${REDPANDA_SCHEMA_REGISTRY}:8081
    command:
      - redpanda
      - start
      - --smp 1
      - --memory 1G
      - --mode dev-container
      - --default-log-level=info
      - --kafka-addr 0.0.0.0:9092
      - --pandaproxy-addr 0.0.0.0:8082
      - --schema-registry-addr 0.0.0.0:8081

  postgres:
    container_name: postgres
    image: postgres:14.5-alpine
    ports:
      - ${POSTGRES}:5432
    command: ["postgres", "-cshared_preload_libraries=pg_stat_statements"]
    volumes:
      - ./postgres/create-tables.sql:/docker-entrypoint-initdb.d/create-tables.sql:ro
    environment:
      POSTGRES_INITDB_ARGS: "--encoding UTF8 --locale=C"
      POSTGRES_HOST_AUTH_METHOD: trust
      POSTGRES_USER: dev
      POSTGRES_PASSWORD:

  graph-node:
    container_name: graph-node
    build: { dockerfile: graph-node/Dockerfile }
    ports:
      - ${GRAPH_NODE_GRAPHQL}:8000
      - ${GRAPH_NODE_ADMIN}:8020
      - ${GRAPH_NODE_STATUS}:8030
      - ${GRAPH_NODE_METRICS}:8040
    healthcheck:
      test: curl -f http://localhost:8000
    depends_on:
      - postgres
      - ipfs
      - chain

  graph-contracts:
    container_name: graph-contracts
    build: { dockerfile: graph-contracts/contracts.dockerfile }
    depends_on:
      - chain

  graph-subgraph:
    container_name: graph-subgraph
    build: { dockerfile: graph-contracts/subgraph.dockerfile }
    depends_on:
      ipfs: 
        condition: service_healthy
      graph-node: 
        condition: service_healthy
    #   graph-contracts:
    #     condition: service_completed_successfully

  block-oracle:
    container_name: block-oracle
    build: { dockerfile: block-oracle/Dockerfile }
    depends_on:
      graph-node:
        condition: service_healthy
    #   graph-contracts:
    #     condition: service_completed_successfully

  indexer-agent:
    container_name: indexer-agent
    build: { dockerfile: indexer/indexer-ts.dockerfile }
    command: sh indexer/agent.sh
    ports:
      - ${INDEXER_MANAGEMENT}:18000
    depends_on:
      - graph-node
      - ipfs
      - chain
      - controller
      - postgres
      - gateway
      - indexer-service

  tap-agent:
    container_name: tap-agent
    build: { dockerfile: indexer-rs/tap-agent.dockerfile }
    depends_on:
      - graph-node
      - controller
      - postgres
      - tap-aggregator

  tap-aggregator:
    container_name: tap-aggregator
    build: { dockerfile: tap-aggregator/Dockerfile }

  tap-contracts:
    container_name: tap-contracts
    build: { dockerfile: tap-contracts/contracts.dockerfile }
    depends_on:
      controller: 
        condition: service_started
      chain: 
        condition: service_healthy

  tap-contract-calls:
    container_name: tap-contract-calls
    build: { dockerfile: tap-contract-calls/Dockerfile }
    depends_on:
      controller: 
        condition: service_started
      chain: 
        condition: service_healthy
    # depends_on:
    #   tap-contracts: 
    #     condition: service_completed_successfully

  tap-subgraph:
    container_name: tap-subgraph
    build: { dockerfile: tap-subgraph/subgraph.dockerfile }
    depends_on:
      # tap-contracts: 
      #   condition: service_completed_successfully
      ipfs: 
        condition: service_healthy
      graph-node: 
        condition: service_healthy

  indexer-service:
    container_name: indexer-service
    build: { dockerfile: indexer-rs/indexer-service.dockerfile }
    ports:
      - ${INDEXER_SERVICE}:7600
    depends_on:
      graph-node:
        condition: service_healthy
      controller:
        condition: service_started
      postgres:
        condition: service_started

  indexer-allocation:
    container_name: indexer-allocation
    build: { dockerfile: indexer/allocation.dockerfile }
    depends_on:
      - controller
      - indexer-agent
      - ipfs
      - chain

  studio-api:
    container_name: studio-api
    build:
      dockerfile: studio/Dockerfile
      ssh: ["default"]
    command: sh studio/api.sh
    ports:
      - ${STUDIO_API}:4000

  studio-admin:
    container_name: studio-admin
    build:
      dockerfile: studio/Dockerfile
      ssh: ["default"]
    command: sh studio/admin.sh
    ports:
      - ${STUDIO_ADMIN}:4003

  tap-escrow-manager:
    container_name: tap-escrow-manager
    build:
      dockerfile: tap-escrow-manager/Dockerfile
      ssh: ['default']
    depends_on:
      graph-node:
        condition: service_healthy
      redpanda:
        condition: service_started
      chain:
        condition: service_healthy

  gateway:
    container_name: gateway
    build:
      dockerfile: gateway/Dockerfile
      ssh: ["default"]
    ports:
      - ${GATEWAY}:6700
    depends_on:
      graph-node:
        condition: service_healthy
      # graph-subgraph:
      #   condition: service_completed_successfully
      # graph-contracts:
      #   condition: service_completed_successfully
      # tap-contracts:
      #   condition: service_completed_successfully
      # tap-contract-calls:
      #   condition: service_completed_successfully
      # indexer-allocation:
      #   condition: service_completed_successfully
      block-oracle:
        condition: service_started
