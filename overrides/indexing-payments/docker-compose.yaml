# Indexing Payments Override
# Adds dipper service for indexing fee payments
# Usage: docker compose -f docker-compose.yaml -f overrides/indexing-payments/docker-compose.yaml up

services:
  # Mock IISA service for local development
  # Provides indexer selection endpoints without BigQuery dependency
  iisa-mock:
    container_name: iisa-mock
    build:
      context: ./overrides/indexing-payments/iisa-mock
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/health')"]
      interval: 5s
      retries: 10
    restart: unless-stopped

  # Add dipper service for indexing payment processing
  dipper:
    container_name: dipper
    build:
      context: ./dipper
      dockerfile: Dockerfile
      target: wrapper-dev # or wrapper-prebuilt for releases
    depends_on:
      block-oracle: { condition: service_healthy }
      postgres: { condition: service_healthy }
      gateway: { condition: service_healthy }
      iisa-mock: { condition: service_healthy }
    ports:
      - "${DIPPER_ADMIN_RPC_PORT}:${DIPPER_ADMIN_RPC_PORT}"
      - "${DIPPER_INDEXER_RPC_PORT}:${DIPPER_INDEXER_RPC_PORT}"
    volumes:
      - ./config/shared:/opt/shared:ro
      - ./config/local:/opt/config:ro
    environment:
      RUST_BACKTRACE: full
      RUST_LOG: debug
    healthcheck:
      interval: 5s
      retries: 10
      # Dipper uses JSON-RPC, so we check if it responds to any POST request
      test:
        [
          "CMD-SHELL",
          "curl -s -X POST -H 'Content-Type: application/json' -d '{\"jsonrpc\":\"2.0\",\"method\":\"health\",\"id\":1}' http://localhost:9000/ | grep -q jsonrpc",
        ]
    restart: unless-stopped

  # Optional: Override indexer-agent if indexing-payment-specific config needed
  # indexer-agent:
  #   environment:
  #     - INDEXING_PAYMENTS_ENABLED=true
  #     - DIPPER_URL=http://dipper:${DIPPER_INDEXER_RPC_PORT}
